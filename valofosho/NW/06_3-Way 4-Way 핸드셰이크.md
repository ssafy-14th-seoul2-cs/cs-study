# 🔄 TCP 연결 설정 및 해제 — 3-Way / 4-Way Handshake

> **TCP(Transmission Control Protocol)** 는  
> **신뢰성 있는 양방향 통신**을 위해 연결을 설정(3-Way)하고,  
> 전송이 끝난 후 연결을 해제(4-Way)한다.

---

## ⚙️ 1️⃣ 3-Way Handshake (연결 설정)

> **송신자(Client)** 와 **수신자(Server)** 가 서로 연결을 맺기 위해  
> **SYN(연결 요청)** 과 **ACK(응답 확인)** 플래그를 주고받는 과정

```

[Client]                                        [Server]
│                                               │
│ --- SYN ------------------------------------> │ ① 연결 요청
│                                               │
│ <--- SYN + ACK ------------------------------ │ ② 요청 수락 + 응답
│                                               │
│ --- ACK ------------------------------------> │ ③ 수락 확인
│                                               │

```

| 단계 | 송신자(Client) | 수신자(Server) | 설명 |
|:--:|:--|:--|:--|
| ① | SYN=1, Seq=x |  | 클라이언트가 연결 요청 (세션 시작 요청) |
| ② |  | SYN=1, ACK=1, Seq=y, Ack=x+1 | 서버가 요청 수락 및 응답 |
| ③ | ACK=1, Seq=x+1, Ack=y+1 |  | 클라이언트가 응답 확인 후 연결 완료 |

---

### ✅ 연결 완료 후
- 양측 모두 **연결이 성립**되어 데이터 송수신 가능  
- TCP는 이때 **양방향 전이중(Full-duplex)** 통신 채널을 구성

---

### 🧠 왜 3번(3-Way)일까?
1. **1-Way (불가)**: 단방향 요청만으로는 수신 측이 준비됐는지 모름  
2. **2-Way (불완전)**: 송신 측은 자신이 보낸 게 수신됐는지 모르고 시작함  
3. **3-Way (완전)**: 양측 모두 송신·수신 가능 상태를 확인하고 시작  

> 즉, **양쪽의 송·수신 상태를 모두 확인해야** 신뢰성 있는 연결이 가능하다.

---

## ⚙️ 2️⃣ 4-Way Handshake (연결 해제)

> TCP 연결 종료는 데이터 송수신을 양방향으로 모두 닫아야 하므로  
> 4단계(4-Way) 절차로 진행된다.

```

[Client]                                        [Server]
│                                               │
│ --- FIN ------------------------------------> │ ① 연결 종료 요청
│                                               │
│ <--- ACK ------------------------------------ │ ② 종료 요청 수락
│                                               │
│ <--- FIN ------------------------------------ │ ③ 서버 측 종료 요청
│                                               │
│ --- ACK ------------------------------------> │ ④ 종료 응답
│                                               │

```

| 단계 | 송신자(Client) | 수신자(Server) | 설명 |
|:--:|:--|:--|:--|
| ① | FIN=1, Seq=u |  | 클라이언트가 연결 종료 요청 |
| ② |  | ACK=1, Ack=u+1 | 서버가 요청 수락, 데이터 전송 마무리 중 |
| ③ |  | FIN=1, Seq=v | 서버가 자신의 송신 종료 요청 |
| ④ | ACK=1, Ack=v+1 |  | 클라이언트가 응답 후 세션 종료 |

---

### ⏱ 상태 변화 요약

| 단계 | 클라이언트 상태 | 서버 상태 |
|:--|:--|:--|
| 연결 종료 요청 전 | ESTABLISHED | ESTABLISHED |
| FIN 송신 후 | FIN_WAIT_1 | CLOSE_WAIT |
| ACK 수신 후 | FIN_WAIT_2 | CLOSE_WAIT |
| 서버의 FIN 수신 후 | TIME_WAIT | LAST_ACK |
| 최종 종료 | CLOSED | CLOSED |

> 💡 **TIME_WAIT**: 마지막 ACK 손실을 대비해 일정 시간(2MSL) 대기하는 상태  
> (중복 FIN에 안전하게 응답할 수 있도록 보장)

---

### 🧠 왜 4번(4-Way)일까?
- **데이터 송수신이 독립적(Full-duplex)** 이기 때문  
  → 송신과 수신을 **각각 따로 종료**해야 함  
- 한쪽에서 FIN을 보내더라도,  
  상대방은 아직 보낼 데이터가 남아 있을 수 있음 → **ACK → FIN → ACK**

---

## 🧩 3️⃣ Graceful vs Abrupt Connection Termination

### 🔹 Graceful Connection Release (정상적인 연결 해제)
- **4-Way Handshake**를 이용해 양측이 정상적으로 연결 종료
- 양쪽 모두 FIN과 ACK 교환을 통해 안전하게 닫음
- **Half-Close 기법** 사용으로 데이터 손실 없이 종료 가능

### 🔹 Abrupt Connection Release (갑작스러운 연결 해제)
- **RST (Reset) 세그먼트**를 이용해 즉시 연결 강제 종료  
- 비정상 상황에서 연결을 끊을 때 사용

| 상황 | 설명 |
|:--|:--|
| **존재하지 않는 연결로 세그먼트 수신 시** | 존재하지 않는 포트로 데이터 도착 시 RST 응답 |
| **헤더 오류 발생 시** | TCP 헤더 손상 → 연결 초기화 |
| **리소스 부족 / 비정상 상태** | 시스템 리소스 한계 시 연결 강제 종료 |
| **보안 목적** | 공격 트래픽 또는 비인가 세션 종료 |

---

## 🔹 Half-Close 기법 (절반 종료)

> 연결을 완전히 끊지 않고, “한쪽 방향만 닫는” 방식  
> → 송신은 종료하지만 수신은 계속 열어두는 구조

```

Client (송신 종료)
│ FIN + ACK  ─────────▶ Server (수신 대기)
│                       │
│                       └── 아직 남은 데이터 전송 후 FIN 응답
│ ◀───────────  FIN + ACK
│ ───────────▶  ACK (마지막 확인)

```

- **Step 1:** Client → Server : FIN(+ACK)  
  클라이언트가 close() 호출 → 서버에 연결 종료 의사 전달  
  이때 FIN에는 기존 ACK 번호도 함께 포함됨 (Half-Close 적용)

- **Step 2:** Server → Client : ACK  
  서버는 FIN 수신 후, “데이터 전송 중임”을 의미하는 ACK 전송  
  이후 남은 데이터 전송 완료 시까지 **CLOSE_WAIT 상태** 유지

- **Step 3:** Server → Client : FIN  
  데이터 전송 완료 후, 서버는 FIN 전송 및 **LAST_ACK 상태** 진입

- **Step 4:** Client → Server : ACK  
  클라이언트는 FIN 수신 후 ACK 응답 → **TIME_WAIT 상태** 유지  
  이후 2MSL(Time Wait) 경과 후 최종 CLOSED

> ✅ Half-Close는 "한쪽은 닫되, 다른 쪽은 아직 남은 데이터 송신 가능"한 안전 종료 방식  
> 데이터 유실 없이 Graceful 종료가 가능하다.

---

## ⚡ TIME_WAIT 상태의 의미

| 항목 | 설명 |
|:--|:--|
| **목적** | FIN/ACK 유실에 대비, 중복 패킷 재도착 방지 |
| **대기 시간** | 2MSL(Maximum Segment Lifetime, 약 1~4분) |
| **발생 위치** | 마지막으로 ACK를 보낸 쪽 (주로 클라이언트) |
| **이유** | 네트워크 내 남은 패킷이 완전히 사라질 때까지 대기 |

---

## 🔍 4️⃣ TCP 플래그 요약

| 플래그 | 이름 | 역할 |
|:--:|:--|:--|
| **SYN** | Synchronize | 연결 요청 (시퀀스 번호 동기화) |
| **ACK** | Acknowledgment | 응답 확인 |
| **FIN** | Finish | 연결 종료 요청 |
| **RST** | Reset | 비정상 연결 강제 종료 |
| **PSH** | Push | 즉시 전송 요청 (버퍼 대기 없이) |
| **URG** | Urgent | 긴급 데이터 표시 |

---

## 🧠 상태 변화 전체 요약

```

Client 상태 변화

CLOSED
↓
SYN_SENT (SYN 전송)
↓
ESTABLISHED (3-Way 완료)
↓
FIN_WAIT_1 (FIN 전송)
↓
FIN_WAIT_2 (ACK 수신)
↓
TIME_WAIT (서버 FIN 수신 후 ACK)
↓
CLOSED (2MSL 후 종료)

```

---

## ✅ 핵심 요약

| 구분 | 3-Way Handshake | 4-Way Handshake |
|:--|:--|:--|
| **역할** | TCP 연결 설정 | TCP 연결 종료 |
| **패킷 수** | 3개 (SYN, SYN+ACK, ACK) | 4개 (FIN, ACK, FIN, ACK) |
| **방향성** | 양방향 송·수신 준비 확인 | 양방향 송·수신 종료 확인 |
| **상태** | SYN_SENT → ESTABLISHED | FIN_WAIT → TIME_WAIT |
| **Half-Close 지원** | ❌ | ✅ |
| **Abrupt 종료** | RST 사용 | RST 사용 |
| **특징** | 신뢰성 있는 연결 확립 | 안전한 종료 및 재전송 대비 |

---

> ✅ **최종 요약:**  
> - **3-Way Handshake**: 연결을 “확립”하기 위한 SYN/ACK 교환  
> - **4-Way Handshake**: 연결을 “종료”하기 위한 FIN/ACK 교환  
> - **Graceful 종료**는 데이터 손실 없이 안전하게 닫는 Half-Close 기반  
> - **Abrupt 종료**는 RST로 강제 종료하며, TIME_WAIT은 재전송 안정성을 보장한다.
```
