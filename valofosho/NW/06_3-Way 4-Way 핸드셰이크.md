# 🔄 TCP 연결 설정 및 해제 — 3-Way / 4-Way Handshake

> **TCP(Transmission Control Protocol)** 는  
> **신뢰성 있는 양방향 통신**을 위해 연결을 설정(3-Way)하고,  
> 전송이 끝난 후 연결을 해제(4-Way)한다.

---

## ⚙️ 1️⃣ 3-Way Handshake (연결 설정)

> **송신자(Client)** 와 **수신자(Server)** 가 서로 연결을 맺기 위해  
> **SYN(연결 요청)** 과 **ACK(응답 확인)** 플래그를 주고받는 과정

```

[Client]                                        [Server]
│                                               │
│ --- SYN ------------------------------------> │ ① 연결 요청
│                                               │
│ <--- SYN + ACK ------------------------------ │ ② 요청 수락 + 응답
│                                               │
│ --- ACK ------------------------------------> │ ③ 수락 확인
│                                               │

```

| 단계 | 송신자(Client) | 수신자(Server) | 설명 |
|:--:|:--|:--|:--|
| ① | SYN=1, Seq=x |  | 클라이언트가 연결 요청 (세션 시작 요청) |
| ② |  | SYN=1, ACK=1, Seq=y, Ack=x+1 | 서버가 요청 수락 및 응답 |
| ③ | ACK=1, Seq=x+1, Ack=y+1 |  | 클라이언트가 응답 확인 후 연결 완료 |

---

### ✅ 연결 완료 후
- 양측 모두 **연결이 성립**되어 데이터 송수신 가능  
- TCP는 이때 **양방향 전이중(Full-duplex)** 통신 채널을 구성

---

### 🧠 왜 3번(3-Way)일까?
1. **1-Way (불가)**: 단방향 요청만으로는 수신 측이 준비됐는지 모름  
2. **2-Way (불완전)**: 송신 측은 자신이 보낸 게 수신됐는지 모르고 시작함  
3. **3-Way (완전)**: 양측 모두 송신·수신 가능 상태를 확인하고 시작

> 즉, **양쪽의 송·수신 상태를 모두 확인해야** 신뢰성 있는 연결이 가능하다.

---

## ⚙️ 2️⃣ 4-Way Handshake (연결 해제)

> TCP 연결 종료는 데이터 송수신을 양방향으로 모두 닫아야 하므로  
> 4단계(4-Way) 절차로 진행된다.

```

[Client]                                        [Server]
│                                               │
│ --- FIN ------------------------------------> │ ① 연결 종료 요청
│                                               │
│ <--- ACK ------------------------------------ │ ② 종료 요청 수락
│                                               │
│ <--- FIN ------------------------------------ │ ③ 서버 측 종료 요청
│                                               │
│ --- ACK ------------------------------------> │ ④ 종료 응답
│                                               │

```

| 단계 | 송신자(Client) | 수신자(Server) | 설명 |
|:--:|:--|:--|:--|
| ① | FIN=1, Seq=u |  | 클라이언트가 연결 종료 요청 |
| ② |  | ACK=1, Ack=u+1 | 서버가 요청 수락, 데이터 전송 마무리 중 |
| ③ |  | FIN=1, Seq=v | 서버가 자신의 송신 종료 요청 |
| ④ | ACK=1, Ack=v+1 |  | 클라이언트가 응답 후 세션 종료 |

---

### ⏱ 상태 변화 요약

| 단계 | 클라이언트 상태 | 서버 상태 |
|:--|:--|:--|
| 연결 종료 요청 전 | ESTABLISHED | ESTABLISHED |
| FIN 송신 후 | FIN_WAIT_1 | CLOSE_WAIT |
| ACK 수신 후 | FIN_WAIT_2 | CLOSE_WAIT |
| 서버의 FIN 수신 후 | TIME_WAIT | LAST_ACK |
| 최종 종료 | CLOSED | CLOSED |

> 💡 **TIME_WAIT**: 마지막 ACK 손실을 대비해 일정 시간(2MSL) 대기하는 상태  
> (중복 FIN에 안전하게 응답할 수 있도록 보장)

---

### 🧠 왜 4번(4-Way)일까?
- **데이터 송수신이 독립적(Full-duplex)** 이기 때문  
  → 송신과 수신을 **각각 따로 종료**해야 함  
- 한쪽에서 FIN을 보내더라도,  
  상대방은 아직 보낼 데이터가 남아 있을 수 있음 → **ACK → FIN → ACK**

---

## 🔍 3️⃣ 플래그 요약

| 플래그 | 이름 | 역할 |
|:--:|:--|:--|
| **SYN** | Synchronize | 연결 요청 (시퀀스 동기화) |
| **ACK** | Acknowledgment | 응답 확인 |
| **FIN** | Finish | 연결 종료 요청 |
| **RST** | Reset | 비정상 연결 리셋 |
| **PSH** | Push | 버퍼 데이터 즉시 전송 요청 |
| **URG** | Urgent | 긴급 데이터 표시 |

---

## 📊 상태 전이(State Transition) 다이어그램

```

```
     ┌───────────────┐
     │   LISTEN      │
     └──────┬────────┘
            │ SYN
            ▼
    ┌───────────────┐
    │ SYN_RECEIVED  │
    └──────┬────────┘
```

SYN+ACK ▲      │ ACK
│      ▼
┌───────────────┐
│ ESTABLISHED   │   ← 데이터 송수신
└──────┬────────┘
FIN→   │
▼
┌───────────────┐
│ FIN_WAIT_1    │
├───────────────┤
│ FIN_WAIT_2    │
├───────────────┤
│ TIME_WAIT     │
└───────────────┘

```

---

## 🧠 핵심 요약

| 구분 | 3-Way Handshake | 4-Way Handshake |
|:--|:--|:--|
| **역할** | TCP 연결 설정 | TCP 연결 종료 |
| **패킷 수** | 3개 (SYN, SYN+ACK, ACK) | 4개 (FIN, ACK, FIN, ACK) |
| **방향성** | 양방향 송·수신 준비 확인 | 양방향 송·수신 종료 확인 |
| **상태** | SYN_SENT → ESTABLISHED | FIN_WAIT → TIME_WAIT |
| **특징** | 신뢰성 있는 연결 확립 | 안전한 종료 및 재전송 대비 |

---

> ✅ **한줄 요약:**  
> - **3-Way Handshake**: 연결을 "확립"하기 위한 상호 SYN/ACK 교환  
> - **4-Way Handshake**: 연결을 "종료"하기 위한 양방향 FIN/ACK 교환  
> → TCP는 **신뢰성**을 위해 항상 양방향 상태를 **명시적으로 확인**한다.
```
