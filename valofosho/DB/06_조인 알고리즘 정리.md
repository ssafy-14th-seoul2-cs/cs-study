# 🧩 조인 알고리즘 (Join Algorithm)

> **조인(Join)** 이란 두 개 이상의 테이블을 연결해 하나의 결과 집합으로 만드는 연산입니다.
>
> 하지만 단순히 SQL 문법의 `JOIN`을 실행한다고 해서 모든 경우가 같은 속도로 처리되는 것은 아닙니다.
>
> DBMS는 내부적으로 **조인 알고리즘(Join Algorithm)** 을 선택하여 최적화된 방식으로 데이터를 결합합니다.

---

## 📘 1️⃣ 조인의 종류 (논리적 관점)

| 구분                   | 설명                              | 예시                                       |
| -------------------- | ------------------------------- | ---------------------------------------- |
| **INNER JOIN**       | 두 테이블에서 **공통된 값**만 결합           | `SELECT * FROM A JOIN B ON A.id = B.id;` |
| **LEFT OUTER JOIN**  | 왼쪽 테이블의 모든 데이터 + 오른쪽 일치 데이터     | `SELECT * FROM A LEFT JOIN B ...`        |
| **RIGHT OUTER JOIN** | 오른쪽 테이블의 모든 데이터 + 왼쪽 일치 데이터     | `SELECT * FROM A RIGHT JOIN B ...`       |
| **FULL OUTER JOIN**  | 양쪽 테이블의 모든 데이터 결합 (일치하지 않아도 포함) | 일부 DB에서만 지원                              |
| **CROSS JOIN**       | 모든 행을 조합 (Cartesian Product)    | `SELECT * FROM A, B;`                    |

> 🔸 이 중에서 실제 **물리적 수행 방식**이 바로 **조인 알고리즘(Join Algorithm)** 이다.

---

## ⚙️ 2️⃣ 조인 알고리즘의 종류 (물리적 관점)

DBMS는 데이터의 크기, 인덱스 존재 여부, 통계 정보 등을 고려해
다음 세 가지 중 하나의 **물리적 조인 방식**을 옵티마이저가 선택합니다.

---

### 🔹 ① Nested Loop Join (중첩 루프 조인)

가장 기본적인 조인 방식으로, **한쪽 테이블(A)** 의 행을 하나씩 가져와
**다른 테이블(B)** 을 순차적으로 검색하며 일치하는 행을 찾습니다.

```sql
for row in A:
    for row in B:
        if A.key == B.key:
            result.append(...)
```

📊 **특징**

* 작은 테이블과 큰 테이블을 조인할 때 적합
* 인덱스가 있을 경우 **Index Nested Loop Join** 으로 최적화 가능
* 인덱스가 없으면 **비효율적 (O(N×M))**

📈 **성능 개선**

* 내부 루프 테이블(B)에 인덱스를 설정
* 드라이빙 테이블(외부 루프)은 작은 테이블로 선택

---

### 🔹 ② Sort-Merge Join (정렬 병합 조인)

두 테이블 모두 **조인 키를 기준으로 정렬(Sort)** 한 뒤,
정렬된 데이터를 **병합(Merge)** 하면서 일치하는 행을 결합합니다.

```text
A(id) → 1, 2, 3, 5
B(id) → 2, 3, 4, 5

→ Merge 단계에서 일치하는 2,3,5를 빠르게 매칭
```

📊 **특징**

* 정렬된 테이블에 대해 매우 효율적
* 인덱스가 없을 때도 성능이 안정적
* `BETWEEN`, `>=`, `<=` 등 범위 조인에 유리

📈 **단점**

* 정렬(Sort) 과정의 오버헤드 존재 (특히 대용량일 때 비용 큼)
* 랜덤 액세스보다 대량의 **순차 접근(Sequential Scan)** 에 적합

---

### 🔹 ③ Hash Join (해시 조인)

작은 테이블(보통 왼쪽 테이블)의 조인 키로 **Hash Table** 을 만들고,
큰 테이블의 각 행을 탐색하며 **해시 함수로 매칭**하는 방식.

```sql
# Build Phase
hash_table = {}
for row in small_table:
    hash_table[row.key] = row

# Probe Phase
for row in large_table:
    if row.key in hash_table:
        result.append(...)
```

📊 **특징**

* **대용량 조인에 매우 효율적**
* 인덱스가 없어도 빠른 조인 가능
* 정렬 과정이 없어 Sort-Merge보다 빠름
* 주로 OLAP, DW 환경에서 사용

📈 **단점**

* 해시 테이블을 위한 **메모리 사용량 큼**
* 해시 충돌 시 성능 저하 가능

---

## 🧮 3️⃣ 조인 알고리즘 비교표

| 구분             | Nested Loop Join | Sort-Merge Join      | Hash Join              |
| -------------- | ---------------- | -------------------- | ---------------------- |
| **기본 아이디어**    | 한 행씩 비교          | 정렬 후 병합              | 해시 테이블 기반              |
| **인덱스 필요 여부**  | 필요 (있으면 빠름)      | 불필요                  | 불필요                    |
| **적합한 상황**     | 작은 테이블 + 인덱스 조인  | 정렬된 테이블              | 대용량 조인                 |
| **복잡도**        | O(N×M)           | O(N log N + M log M) | O(N + M)               |
| **메모리 사용량**    | 낮음               | 중간                   | 높음                     |
| **대표 사용 DBMS** | MySQL, Oracle    | PostgreSQL, Oracle   | PostgreSQL, SQL Server |

---

## ⚖️ 4️⃣ 옵티마이저의 조인 선택 기준

DB 옵티마이저(Query Optimizer)는 다음 요인을 고려해 조인 방식을 선택합니다:

| 기준            | 설명                                                          |
| ------------- | ----------------------------------------------------------- |
| **데이터 양**     | 작은 테이블 → Nested Loop / 큰 테이블 → Hash Join                    |
| **인덱스 존재 여부** | 인덱스가 있으면 Nested Loop Join 우선                                |
| **정렬 여부**     | 이미 정렬되어 있으면 Sort-Merge Join 유리                              |
| **메모리 버퍼 크기** | 메모리 충분 → Hash Join / 부족 → Sort-Merge Join                   |
| **조인 조건**     | `=` (등가조인) → Hash Join,  `<`, `>` (비등가조인) → Sort-Merge Join |

---

## 🔍 5️⃣ MySQL 예시 (EXPLAIN)

```sql
EXPLAIN SELECT *
FROM employees e
JOIN departments d
ON e.dept_id = d.id;
```

결과에서 **`type`**, **`Extra`** 컬럼을 보면 조인 방식 추론 가능

* `type = ref` 또는 `eq_ref` → 인덱스 기반 Nested Loop Join
* `Using temporary; Using filesort` → Sort-Merge Join 가능성
* `Block Nested Loop` 또는 `Hash Join` → 대용량 조인

---

## 📊 6️⃣ 조인 방식 시각화

```
Nested Loop Join
 ├─ 작은 테이블: 반복
 └─ 큰 테이블: 인덱스 탐색

Sort-Merge Join
 ├─ 두 테이블 정렬
 └─ 정렬 결과 병합

Hash Join
 ├─ 작은 테이블 해시 생성 (Build)
 └─ 큰 테이블에서 해시 조회 (Probe)
```

---

## 🧠 7️⃣ 요약

| 알고리즘                 | 특징 요약                  | 권장 사용 시점                  |
| -------------------- | ---------------------- | ------------------------- |
| **Nested Loop Join** | 단순, 인덱스 필요, 소규모 조인에 적합 | 인덱스 기반 실시간 조인             |
| **Sort-Merge Join**  | 정렬 후 병합, 범위 조인 효율적     | 이미 정렬된 테이블 간 조인           |
| **Hash Join**        | 해시 기반, 대용량에 강함         | DW/OLAP 대용량 조인, 인덱스 없는 경우 |

---
