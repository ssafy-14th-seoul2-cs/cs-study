# 💾 트랜잭션(Transaction) & ACID 정리

> 데이터베이스에서 **논리적으로 하나의 작업 단위**로 묶인 연산들의 집합
> → **모두 성공(Commit)** 하거나 **모두 실패(Rollback)** 해야 함.

---

## 🧩 1️⃣ 트랜잭션(Transaction)이란?

| 구분        | 설명                                                      |
| --------- | ------------------------------------------------------- |
| **정의**    | 데이터베이스의 상태를 변화시키는 하나 이상의 SQL 문장들의 집합                    |
| **예시**    | 계좌이체 (출금 + 입금) → 둘 중 하나라도 실패하면 전체 취소                    |
| **핵심 목적** | 데이터의 **일관성 유지** 및 **무결성 보장**                            |
| **단위 예시** | `INSERT`, `UPDATE`, `DELETE`, `SELECT ... FOR UPDATE` 등 |

---

## ⚙️ 2️⃣ 트랜잭션의 동작 흐름

```
[BEGIN] → [실행 중] → [COMMIT or ROLLBACK] → [종료]
```

| 단계                            | 설명                        | SQL 예시                           |
| ----------------------------- | ------------------------- | -------------------------------- |
| **BEGIN / START TRANSACTION** | 트랜잭션 시작                   | `BEGIN;` or `START TRANSACTION;` |
| **COMMIT**                    | 모든 작업을 **확정** (DB에 영구 반영) | `COMMIT;`                        |
| **ROLLBACK**                  | 오류 발생 시 **모든 변경 취소**      | `ROLLBACK;`                      |

---

### 🧾 예시: 계좌 이체

```sql
BEGIN;

UPDATE accounts SET balance = balance - 10000 WHERE id = 'A';  -- 출금
UPDATE accounts SET balance = balance + 10000 WHERE id = 'B';  -- 입금

COMMIT;  -- 둘 다 성공해야 영구 반영
```

> 만약 중간에 오류 발생 시 → `ROLLBACK;`
> 두 명의 잔액이 모두 이전 상태로 복원됨

---

## 🧠 3️⃣ 트랜잭션의 4대 특성 (ACID)

| 특성                  | 영어명 | 설명                                       | 예시                                  |
| ------------------- | --- | ---------------------------------------- | ----------------------------------- |
| **A (Atomicity)**   | 원자성 | 트랜잭션 내 모든 작업이 **전부 수행되거나 전혀 수행되지 않음**    | A → B 송금 중 A 출금 후 B 입금 실패 시 → 전체 취소 |
| **C (Consistency)** | 일관성 | 트랜잭션 전후로 **데이터 무결성과 제약조건**이 유지되어야 함      | 잔액 합계가 트랜잭션 전후 동일                   |
| **I (Isolation)**   | 고립성 | 여러 트랜잭션이 동시에 실행되어도 **서로의 중간 결과를 볼 수 없음** | A가 수정 중인 데이터를 B가 읽지 못함              |
| **D (Durability)**  | 지속성 | 트랜잭션이 커밋되면 **시스템 장애에도 결과가 보존**           | COMMIT 후 서버 다운되어도 데이터 유지            |

---

## 🔐 4️⃣ Isolation(고립성)의 수준 (격리 수준)

> 트랜잭션 간 **동시성 제어(Concurrency Control)** 를 위해 설정하는 단계
> — 낮을수록 성능 ↑, 높을수록 일관성 ↑

| 격리 수준                | 설명                          | 발생 가능한 문제           | SQL 설정                                              |
| -------------------- | --------------------------- | ------------------- | --------------------------------------------------- |
| **READ UNCOMMITTED** | 커밋되지 않은 데이터 읽기 허용           | Dirty Read          | `SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;` |
| **READ COMMITTED**   | 커밋된 데이터만 읽음 (기본: Oracle)    | Non-repeatable Read | `... READ COMMITTED;`                               |
| **REPEATABLE READ**  | 같은 쿼리의 결과 일관 유지 (기본: MySQL) | Phantom Read        | `... REPEATABLE READ;`                              |
| **SERIALIZABLE**     | 완전한 순차 실행 (가장 안전하지만 느림)     | 없음                  | `... SERIALIZABLE;`                                 |

---

### ⚠️ 격리 수준별 문제 정리

| 문제 유형                   | 설명                                           | 발생 가능한 격리 수준     |
| ----------------------- | -------------------------------------------- | ---------------- |
| **Dirty Read**          | 다른 트랜잭션이 아직 **커밋하지 않은 데이터**를 읽음              | READ UNCOMMITTED |
| **Non-repeatable Read** | 같은 쿼리를 두 번 실행했을 때 결과가 다름                     | READ COMMITTED   |
| **Phantom Read**        | 같은 조건으로 SELECT했는데 **새로운 행이 추가/삭제**되어 결과가 달라짐 | REPEATABLE READ  |

---

## 🧱 5️⃣ 트랜잭션 제어 명령어 (TCL)

| 명령어                       | 설명              | 예시                 |
| ------------------------- | --------------- | ------------------ |
| **COMMIT**                | 트랜잭션의 결과를 영구 저장 | `COMMIT;`          |
| **ROLLBACK**              | 이전 상태로 되돌림      | `ROLLBACK;`        |
| **SAVEPOINT**             | 트랜잭션 내 특정 지점 지정 | `SAVEPOINT sp1;`   |
| **ROLLBACK TO SAVEPOINT** | 지정된 지점까지만 되돌림   | `ROLLBACK TO sp1;` |

```sql
BEGIN;
UPDATE users SET balance = 900 WHERE id=1;
SAVEPOINT sp1;
UPDATE users SET balance = 800 WHERE id=2;
ROLLBACK TO sp1;  -- id=1의 변경은 유지됨
COMMIT;
```

---

## 🧮 6️⃣ 트랜잭션과 동시성 제어(Concurrency Control)

| 기법                                           | 설명                                                           |
| -------------------------------------------- | ------------------------------------------------------------ |
| **Locking (잠금)**                             | 데이터를 수정할 때 다른 트랜잭션 접근 제한                                     |
| **Pessimistic Lock (비관적 락)**                 | 데이터 충돌을 미리 막기 위해 잠금 먼저 설정                                    |
| **Optimistic Lock (낙관적 락)**                  | 충돌 가능성 낮다고 가정하고 나중에 검증 (버전 필드 사용)                            |
| **MVCC (Multi-Version Concurrency Control)** | 트랜잭션마다 데이터 버전을 관리하여 동시에 읽기 가능하게 함 (PostgreSQL, MySQL InnoDB) |

---

## 💡 7️⃣ 트랜잭션의 활용 예시

| 상황          | 설명                                   |
| ----------- | ------------------------------------ |
| **은행 계좌이체** | 출금 + 입금 모두 성공해야 일관성 유지               |
| **주문 시스템**  | 주문 등록 + 재고 차감 + 결제 승인 모두 성공 시 Commit |
| **게시판 작성**  | 글 작성 + 첨부파일 등록 → 둘 중 하나 실패 시 전체 취소   |

---

## 🧾 요약 정리

| 항목                    | 핵심 내용              |
| --------------------- | ------------------ |
| **트랜잭션**              | 데이터베이스의 논리적 작업 단위  |
| **ACID**              | 원자성, 일관성, 고립성, 지속성 |
| **Commit / Rollback** | 트랜잭션 확정 / 취소       |
| **Isolation Level**   | 트랜잭션 간 간섭 제어 수준    |
| **Lock & MVCC**       | 동시성 문제 해결 기법       |

---