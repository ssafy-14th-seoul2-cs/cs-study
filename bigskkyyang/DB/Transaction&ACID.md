# 트랜잭션 & ACID

## 트랜잭션(Transaction)이란?

**데이터베이스에서 하나의 논리적 작업 단위를 구성하는 연산들의 집합**

쉽게 말해, 데이터베이스에서 수행되는 여러 개의 작업을 하나로 묶은 것 이 작업들은 **모두 성공하거나, 모두 실패해야 한다**(All or Nothing)

### 1. 활동 (Active)
- 트랜잭션이 **실행 중인 상태**
- 연산들이 정상적으로 수행되고 있다

### 2. 부분 완료 (Partially Committed)
- 트랜잭션의 **마지막 연산까지 실행했지만, 아직 데이터베이스에 반영되지 않은 상태**
- COMMIT 직전 상태

### 3. 완료 (Committed)
- 트랜잭션이 **성공적으로 완료되어 데이터베이스에 반영된 상태**
- 변경사항이 영구적으로 저장된다

### 4. 실패 (Failed)
- 트랜잭션 **실행 중에 오류가 발생**한 상태
- 더 이상 정상적으로 진행될 수 없다

### 5. 철회 (Aborted)
- 트랜잭션이 **비정상적으로 종료되어 롤백된 상태**
- 트랜잭션 시작 전의 상태로 되돌린다

## 트랜잭션의 연산

### 1. COMMIT (커밋)

**트랜잭션의 모든 작업을 확정하고 데이터베이스에 영구적으로 반영**한다.

COMMIT이 성공하면:
- 모든 변경사항이 데이터베이스에 저장된다
- 다른 트랜잭션에서도 변경된 데이터를 볼 수 있다

### 2. ROLLBACK (롤백)

**트랜잭션의 작업을 취소하고 트랜잭션 시작 전 상태로 되돌린다.**

ROLLBACK이 실행되면:
- 트랜잭션의 모든 변경사항이 취소된다
- 데이터베이스는 트랜잭션 시작 전 상태로 돌아간다

### 3. SAVEPOINT (저장점)

**트랜잭션 내에서 특정 지점을 표시**한다. 필요시 그 지점까지만 롤백할 수 있다.

## ACID 속성

ACID는 **트랜잭션이 안전하게 수행되기 위해 보장해야 하는 4가지 특성**이다.

### 1. 원자성 (Atomicity)

**트랜잭션의 모든 연산은 완전히 수행되거나, 전혀 수행되지 않아야 한다** (All or Nothing).

트랜잭션을 구성하는 연산들을 하나의 원자처럼 분리할 수 없는 단위로 취급한다.

**원자성 보장:**
- 연산 2에서 오류가 발생하면, 연산 1도 자동으로 취소된다
- 둘 다 성공하거나, 둘 다 실패한다
- 중간 상태는 존재하지 않는다

**원자성을 보장하는 방법:**
- ROLLBACK을 통해 트랜잭션을 철회한다
- 로그(Log)를 기록하여 복구한다

### 2. 일관성 (Consistency)

**트랜잭션이 실행되기 전과 후에 데이터베이스는 일관된 상태를 유지해야 한다.**

데이터베이스의 모든 제약조건, 규칙, 관계를 위반하지 않아야 한다.

**일관성을 보장하는 방법:**
- 무결성 제약조건(PRIMARY KEY, FOREIGN KEY, CHECK 등) 설정
- 트리거(Trigger) 사용
- 애플리케이션 레벨에서 검증

### 3. 격리성 (Isolation)

**여러 트랜잭션이 동시에 실행될 때, 각 트랜잭션은 다른 트랜잭션의 영향을 받지 않고 독립적으로 실행되어야 한다.**

한 트랜잭션의 중간 결과가 다른 트랜잭션에 보이지 않아야 한다.

**격리성을 보장하는 방법:**
- 잠금(Locking) 메커니즘 사용
- 트랜잭션 격리 수준 설정

### 격리 수준 (Isolation Level)

격리성의 정도를 조절할 수 있다. 격리 수준이 높을수록 안전하지만 성능은 떨어진다.

**1) READ UNCOMMITTED (레벨 0)**
- 가장 낮은 격리 수준
- 다른 트랜잭션의 **커밋되지 않은 데이터도 읽을 수 있다**
- **Dirty Read** 발생 가능

**2) READ COMMITTED (레벨 1)**
- **커밋된 데이터만 읽을 수 있다**
- 대부분의 DBMS의 기본 격리 수준
- **Non-Repeatable Read** 발생 가능

같은 트랜잭션 내에서 같은 데이터를 두 번 읽었는데 값이 다르다.

**3) REPEATABLE READ (레벨 2)**
- 트랜잭션 내에서 **같은 데이터를 여러 번 읽어도 항상 같은 값**을 읽는다
- **Phantom Read** 발생 가능

**4) SERIALIZABLE (레벨 3)**
- 가장 높은 격리 수준
- 트랜잭션들이 **순차적으로 실행되는 것처럼** 동작한다
- 모든 이상 현상을 방지하지만 성능이 가장 낮다

### 4. 지속성 (Durability)

**트랜잭션이 성공적으로 완료(COMMIT)되면, 그 결과는 영구적으로 데이터베이스에 저장되어야 한다.**

시스템에 장애가 발생해도 커밋된 데이터는 손실되지 않아야 한다.

정전이 발생해도 A 계좌의 잔액 증가는 유지되어야 한다.

**지속성을 보장하는 방법:**
- **로그(Log) 기반 회복**: 모든 변경사항을 로그에 기록
- **체크포인트(Checkpoint)**: 주기적으로 메모리의 내용을 디스크에 저장
- **백업(Backup)**: 정기적인 데이터베이스 백업

## 트랜잭션 사용 시 주의사항

### 1. 트랜잭션은 가능한 한 짧게

트랜잭션이 길어질수록 다른 트랜잭션이 대기해야 하는 시간이 길어진다.

### 2. 데드락(Deadlock) 주의

두 개 이상의 트랜잭션이 서로 상대방이 잠근 자원을 기다리는 상황이다.

```
트랜잭션 1:          트랜잭션 2:
A 잠금               B 잠금
B 잠금 대기...       A 잠금 대기...
(무한 대기)          (무한 대기)
```

**데드락 방지 방법:**
- 트랜잭션에서 자원을 접근하는 순서를 동일하게 유지한다
- 트랜잭션을 짧게 유지한다
- 적절한 타임아웃 설정

### 3. 읽기 전용 작업은 트랜잭션 불필요

단순 조회만 하는 경우 트랜잭션을 사용할 필요가 없다.

## ACID가 중요한 이유

ACID 속성은 데이터베이스의 신뢰성을 보장한다.

- **은행 시스템**: 돈이 사라지거나 중복 생성되면 안 된다
- **예약 시스템**: 같은 좌석이 중복 예약되면 안 된다
- **재고 관리**: 재고 수량이 정확해야 한다
- **의료 시스템**: 환자 정보가 정확하고 일관되어야 한다

ACID가 보장되지 않으면 데이터의 무결성이 깨지고, 시스템을 신뢰할 수 없게 된다. 따라서 금융, 의료 등 데이터 정확성이 중요한 분야에서는 ACID를 엄격히 준수하는 관계형 데이터베이스를 주로 사용한다.