# 트랜잭션 격리 수준

## 들어가기 앞서

**선행 개념**
- 트랜잭션(Transaction): DB에서 수행되는 작업의 논리적 단위
- ACID 속성: 원자성, 일관성, 고립성, 지속성
- 동시성(Concurrency): 여러 트랜잭션이 동시에 실행되는 상황

## 격리 수준이 필요한 이유

여러 트랜잭션이 동시에 실행될 때 발생하는 문제들을 제어하기 위함

### 동시성 문제 3가지

| 문제 | 설명 | 예시 |
|------|------|------|
| **Dirty Read** | 커밋되지 않은 데이터를 읽음 | T1이 수정 중인 데이터를 T2가 읽었는데, T1이 롤백됨 |
| **Non-Repeatable Read** | 같은 쿼리의 결과가 달라짐 | T1이 데이터를 읽고 다시 읽는 사이 T2가 해당 데이터를 수정함 |
| **Phantom Read** | 없던 행이 나타남 | T1이 범위 조회 후 다시 조회 시 T2가 삽입한 새 행이 보임 |

## 4가지 격리 수준

격리 수준이 높을수록 데이터 정합성은 높아지지만 동시성 처리 성능은 낮아짐

| 격리 수준 | Dirty Read | Non-Repeatable Read | Phantom Read | 설명 |
|----------|------------|---------------------|--------------|------|
| **READ UNCOMMITTED** | ⭕ 발생 | ⭕ 발생 | ⭕ 발생 | 커밋되지 않은 데이터도 읽음 |
| **READ COMMITTED** | ❌ 방지 | ⭕ 발생 | ⭕ 발생 | 커밋된 데이터만 읽음 (대부분 DB 기본값) |
| **REPEATABLE READ** | ❌ 방지 | ❌ 방지 | ⭕ 발생 | 트랜잭션 내에서 같은 결과 보장 (MySQL 기본값) |
| **SERIALIZABLE** | ❌ 방지 | ❌ 방지 | ❌ 방지 | 완전한 격리, 직렬 실행과 동일 |

## 각 격리 수준 상세

### 1. READ UNCOMMITTED
```
T1: UPDATE account SET balance = 500 WHERE id = 1;
T2: SELECT balance FROM account WHERE id = 1;  -- 500 읽음
T1: ROLLBACK;  -- T2는 존재하지 않는 값을 읽은 셈
```
- 가장 낮은 격리 수준
- 거의 사용되지 않음

### 2. READ COMMITTED
```
T1: SELECT balance FROM account WHERE id = 1;  -- 1000
T2: UPDATE account SET balance = 500 WHERE id = 1; COMMIT;
T1: SELECT balance FROM account WHERE id = 1;  -- 500 (값이 변함)
```
- Oracle, PostgreSQL 기본값
- 커밋된 데이터만 읽음

### 3. REPEATABLE READ
```
T1: SELECT * FROM account WHERE balance > 100;  -- 3건
T2: INSERT INTO account VALUES (4, 150); COMMIT;
T1: SELECT * FROM account WHERE balance > 100;  -- 4건 (Phantom)
```
- MySQL(InnoDB) 기본값
- 같은 행에 대해서는 반복 읽기 보장
- MVCC(Multi-Version Concurrency Control) 사용

### 4. SERIALIZABLE
- 가장 높은 격리 수준
- 모든 문제 방지하지만 성능 저하
- 읽기 작업도 공유 락 획득

## 격리 수준 선택 기준

| 상황 | 권장 격리 수준 |
|------|---------------|
| 데이터 정합성이 최우선 (금융 거래) | SERIALIZABLE |
| 일반적인 웹 애플리케이션 | READ COMMITTED |
| 높은 동시성 필요 & 약간의 불일치 허용 | READ UNCOMMITTED |
| MySQL 사용 시 기본 설정 | REPEATABLE READ |

## 핵심 정리

1. **격리 수준은 트레이드오프**: 격리 수준 ↑ → 정합성 ↑, 성능 ↓
2. **대부분 READ COMMITTED 사용**: 실무에서 가장 많이 사용되는 수준
3. **DB마다 기본값 다름**: MySQL은 REPEATABLE READ, Oracle/PostgreSQL은 READ COMMITTED
4. **필요시 트랜잭션별로 설정 가능**: `SET TRANSACTION ISOLATION LEVEL`