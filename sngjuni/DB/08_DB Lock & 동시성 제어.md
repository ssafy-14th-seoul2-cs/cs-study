# DB Lock & 동시성 제어

## DB Lock (데이터베이스 락)

---

**정의**

- 트랜잭션이 데이터를 읽거나 수정할 때, 다른 트랜잭션이 동일한 자원에 접근하지 못하도록 **잠금(Lock)** 을 설정하는 메커니즘
- 데이터의 **무결성과 일관성**을 유지하기 위한 **동시성 제어의 핵심 도구**

---

**핵심 내용**

1. **필요성**
    - 여러 트랜잭션이 동시에 동일 데이터를 변경하려 하면 **갱신 손실, 불일치, 충돌**이 발생할 수 있음
    - 락을 통해 접근 순서를 제어해 **정확한 결과와 안정성** 확보
2. **락의 종류**
    
    
    | 구분 | 설명 | 특징 |
    | --- | --- | --- |
    | **공유락 (S Lock)** | 읽기 작업 시 설정, 다른 읽기 트랜잭션과 공유 가능 | 쓰기 불가, 읽기 다중 허용 |
    | **배타락 (X Lock)** | 쓰기 작업 시 설정, 독점 접근 | 한 트랜잭션만 접근 가능 |
    | **의도락 (Intention Lock)** | 하위 단위 잠금 예고용 락 | 테이블 락과 행 락 충돌 방지 |
    | **락 단위** | 테이블, 페이지, 행 단위로 설정 | 단위가 작을수록 동시성↑, 관리비용↑ |
3. **락 해제 시점**
    - 트랜잭션 종료 시점(Commit / Rollback)에서 자동 해제
    - 락이 해제되기 전까지는 동일 자원에 접근 불가

---

**특징**

- 락은 트랜잭션의 **원자성(Atomicity)** 과 **격리성(Isolation)** 을 구현하는 핵심 수단
- DBMS는 **락 매니저(Lock Manager)** 를 통해 락 상태를 자동 관리
- 락 단위 조절을 통해 **동시성 ↔ 관리 효율성**을 조정 가능

---

**장단점**

- **장점**
    - 데이터 충돌 및 불일치 방지
    - 트랜잭션 간 간섭 최소화
    - 데이터 무결성 보장
- **단점**
    - 과도한 락은 성능 저하 및 대기 시간 증가
    - 교착상태(Deadlock) 발생 위험

---

## 동시성 제어 (Concurrency Control)

---

**정의**

- 여러 트랜잭션이 동시에 수행될 때 **데이터의 일관성과 무결성을 유지하기 위한 관리 기법**
- DBMS는 다양한 제어 기법을 통해 **트랜잭션 간 충돌을 방지하고 순차적 일관성**을 보장함

---

**핵심 내용**

1. **필요성**
    - 동시에 수행되는 트랜잭션이 동일 데이터를 변경하면 **갱신 손실(Lost Update)**, **Dirty Read**, **일관성 오류**가 발생할 수 있음
    - 이를 방지하기 위해 동시성 제어 기법이 필요함
2. **대표적인 제어 기법**
    - **2단계 락킹(2PL, Two-Phase Locking)**
        - 트랜잭션 수행을 **확장 단계(Growing)** 와 **축소 단계(Shrinking)** 로 구분
        - 확장 단계: 락 획득만 가능, 축소 단계: 락 해제만 가능
        - 모든 락을 확보한 뒤 축소 단계로 이동해야 일관성 보장
    - **타임스탬프 순서 기법(Timestamp Ordering)**
        - 각 트랜잭션에 시간 스탬프를 부여하고, 시간 순서에 따라 충돌 해결
        - 충돌 시 타임스탬프가 뒤인 트랜잭션을 롤백
    - **낙관적 병행 제어(OCC)**
        - 트랜잭션 충돌이 적다고 가정, 마지막 검증 단계에서만 충돌 검사
        - 읽기 위주 트랜잭션에 적합
    - **MVCC (Multi-Version Concurrency Control)**
        - 데이터의 여러 버전을 유지하여 읽기/쓰기 분리
        - 읽기 트랜잭션은 스냅샷 데이터를 조회하므로 락 충돌이 없음 (MySQL InnoDB 기본 방식)
3. **교착상태(Deadlock)**
    - 두 트랜잭션이 **서로의 락을 기다리며 무한 대기**하는 상태
    - 해결 방법: **예방(락 순서 고정, 타임아웃 설정)**, **탐지 및 회복(Deadlock Detection)**

---

**특징**

- 트랜잭션의 **격리성과 무결성 보장**
- 제어 기법마다 **일관성 ↔ 성능**의 트레이드오프 존재
- DBMS 옵티마이저가 내부적으로 최적의 제어 방식을 자동 선택

---

**장단점**

- **장점**
    - 다중 사용자 환경에서도 안정적 데이터 처리
    - 동시 실행 효율 향상
- **단점**
    - 락 경합 및 교착상태 발생 가능
    - 잘못된 설정 시 성능 저하

---

## 관련 면접 질문

- DB Lock이란 무엇이며 왜 필요한가요?
    - 트랜잭션 간 충돌을 방지하기 위해 데이터 접근을 제한하는 메커니즘으로, 데이터 무결성을 유지합니다.
- 2단계 락킹(2PL)의 원리는 무엇인가요?
    - 락을 모두 획득한 후에만 해제할 수 있도록 하여 트랜잭션 간 충돌을 방지하고 일관성을 유지합니다.
- MVCC의 장점은 무엇인가요?
    - 읽기 트랜잭션이 과거 스냅샷을 참조해 락 경합 없이 수행되어 동시성이 향상됩니다.
- 교착상태(Deadlock)는 왜 발생하며 어떻게 해결하나요?
    - 서로의 락을 기다리며 대기하는 상태로, 타임아웃 설정이나 락 순서 고정으로 예방할 수 있습니다.